```
library(GenomicRanges)
library(BiocParallel)
library(ggplot2)
#加载数据
load("chromosome_lengths.RData")
load("h38_man_transcript_p.RData")
load("h38_man_transcript_m.RData")

#封装函数
run_trans_enrichment <- function(
  motif_name,
  n_simulations,
  sequences_per_simulation,
  sequence_length,
  chromosome_lengths,
  h38_man_transcript_p,
  h38_man_transcript_m,
  x_observed,
  y_observed,
  n_cores = 4
) {

  trans_p_gr <- GRanges(
    seqnames = h38_man_transcript_p$chromosome,
    ranges = IRanges(start = h38_man_transcript_p$start,
                     end = h38_man_transcript_p$end + sequence_length - 1),
    strand = h38_man_transcript_p$strand
  )
  trans_m_gr <- GRanges(
    seqnames = h38_man_transcript_m$chromosome,
    ranges = IRanges(start = h38_man_transcript_m$start,
                     end = h38_man_transcript_m$end + sequence_length - 1),
    strand = h38_man_transcript_m$strand
  )
  
  chromosome_data <- data.frame(
    chromosome = names(chromosome_lengths),
    length = chromosome_lengths
  )
 
  cat("Starting simulations for motif:", motif_name, "...\n")
  cat(">> Simulating", n_simulations, "times with", sequences_per_simulation, "sequences per run\n")
  sim_results <- bplapply(1:n_simulations, FUN = function(i) {
    if (i %% 1000 == 0) cat("  Simulation", i, "of", n_simulations, "\n")
    random_chromosomes <- sample(chromosome_data$chromosome, sequences_per_simulation, replace = TRUE)
    random_strand <- sample(c("+", "-"), sequences_per_simulation, replace = TRUE)
    random_positions <- sapply(random_chromosomes, function(chr) {
      sample(1:(chromosome_lengths[chr] - sequence_length + 1), 1)
    })
    
    random_gr <- GRanges(
      seqnames = random_chromosomes,
      ranges = IRanges(start = random_positions,
                       end = random_positions + sequence_length - 1),
      strand = random_strand
    )
    
    sense_hits <- countOverlaps(random_gr, trans_p_gr, type = "any")
    antisense_hits <- countOverlaps(random_gr, trans_m_gr, type = "any")
    
    sense_strand_match <- strand(random_gr[queryHits(sense_hits)]) == strand(utr_p_gr[subjectHits(sense_hits)])
    antisense_strand_match <- strand(random_gr[queryHits(antisense_hits)]) == strand(utr_m_gr[subjectHits(antisense_hits)])

    n_sense <- sum(sense_strand_match) + sum(antisense_strand_match)
    n_antisense <- sum(!sense_strand_match) + sum(!antisense_strand_match)

    list(sense = n_sense, antisense = n_antisense)
  }, BPPARAM = MulticoreParam(workers = n_cores))
  
  trans_sense_count <- sapply(sim_results, `[[`, "sense")
  trans_antisense_count <- sapply(sim_results, `[[`, "antisense")
  
  save(trans_sense_count, file = paste0("trans_sense_count_", motif_name, ".RData"))
  save(trans_antisense_count, file = paste0("trans_antisense_count_", motif_name,".RData"))
  

  plot_freq_curve_with_arrow <- function(sim_data, observed_value, title, color = "blue") {
   df <- data.frame(counts = sim_data)
  
   freq_table <- as.data.frame(table(df$counts))
   colnames(freq_table) <- c("count", "freq")
   freq_table$count <- as.numeric(as.character(freq_table$count))
  
   p <- ggplot(freq_table, aes(x = count, y = freq)) +
     geom_line(color = color, size = 1.2) +
     geom_smooth(method = "loess", se = FALSE, color = color, size = 1.2, span = 0.5) +
    
     annotate("segment",
              x = observed_value, xend = observed_value,
              y = 0, yend = max(freq_table$freq) * 0.6,
              arrow = arrow(length = unit(0.25, "cm")), 
              color = "red", size = 1.2) +
     annotate("text",
              x = observed_value,
              y = max(freq_table$freq) * 1,
              label = paste0("Observed: ", observed_value),
              color = "red",
              angle = 90,
              vjust = -0.5,
              size = 3.5) +
    
     labs(title = title,
          x = "Occurrences in gene",
          y = "Number of Simulations") +
    
     theme_minimal() +
     theme(
       plot.title = element_text(hjust = 0.5, face = "bold"),  # 居中加粗标题
       panel.grid = element_blank()  # 去除网格线
     )
  
   return(p)
  }

  p_sense <- plot_freq_curve_with_arrow(trans_sense_count, x_observed, paste0(motif_name, "in transcript sense"))
  p_antisense <- plot_freq_curve_with_arrow(trans_antisense_count, y_observed, paste0(motif_name, "in transcript antisense"))
  ggsave(filename = paste0("trans_sense_freq_", motif_name, ".png"), plot = p_sense)
  ggsave(filename = paste0("trans_antisense_freq_", motif_name, ".png"), plot = p_antisense)
  
  return(list(sense = trans_sense_count, antisense = trans_antisense_count, p_sense = p_sense, p_antisense = p_antisense))
}

motif_info_df <- data.frame(
  motif_name = c("ATTTTGCTT", "ATTTAGCTT", "ATTATGCTT","ATATTGCTT","AATTTGCTT"),  
  sequences_per_simulation = c(93113, 39345, 38387, 45061, 66106),
  x_observed = c(10787, 4572, 4014, 4980, 7043),
  y_observed = c(10247, 4270, 3927, 4636, 6670),
  stringsAsFactors = FALSE
)

results_list <- list()
for (i in seq_len(nrow(motif_info_df))) {
  motif <- motif_info_df$motif_name[i]
  seq_num <- motif_info_df$sequences_per_simulation[i]
  x_obs <- motif_info_df$x_observed[i]
  y_obs <- motif_info_df$y_observed[i]
  
  cat("Running motif:", motif, "\n")
  start_i <- Sys.time()
  res <- run_trans_enrichment(
    motif_name = motif,
    n_simulations = 10000,
    sequences_per_simulation = seq_num,
    sequence_length = 9,
    chromosome_lengths = chromosome_lengths,
    h38_man_transcript_p = h38_man_transcript_p,
    h38_man_transcript_m = h38_man_transcript_m,
    x_observed = x_obs,
    y_observed = y_obs,
    n_cores = 4
  )
  end_i <- Sys.time()
  cat("==> Finished motif:", motif, "in", round(difftime(end_i, start_i, units = "mins"), 2), "minutes\n")
  results_list[[motif]] <- res
}

save(results_list, file = "all_motif_transcript_enrichment_results.RData")
```
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTQ5MjUzMDE5MCwxNjU0Mjc1NDY5XX0=
-->